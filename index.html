function calculateStrokes(playerHandicap, holeHandicap) {
            if (playerHandicap <= 18) {
                return playerHandicap >= holeHandicap ? 1 : 0;
            } else {
                // For handicaps over 18, player gets 1 stroke on every hole plus additional strokes
                const extraStrokes = playerHandicap - 18;
                return 1 + (extraStrokes >= holeHandicap ? 1 : 0);
            }
        }

        function updatePlayerTotals(groupId, playerId) {
            const holes = courseData.holes;
            let frontTotal = 0, backTotal = 0;
            let netFrontTotal = 0, netBackTotal = 0;
            
            // Calculate front nine
            for (let i = 1; i <= 9; i++) {
                const grossInput = document.getElementById(`score_${groupId}_${playerId}_${i}`);
                const netCell = document.getElementById(`net_${groupId}_${playerId}_${i}`);
                
                if (grossInput && grossInput.value) {
                    frontTotal += parseInt(grossInput.value);
                }
                if (netCell && netCell.textContent !== '-') {
                    netFrontTotal += parseInt(netCell.textContent);
                }
            }
            
            // Calculate back nine if 18 holes
            if (holes.length === 18) {
                for (let i = 10; i <= 18; i++) {
                    const grossInput = document.getElementById(`score_${groupId}_${playerId}_${i}`);
                    const netCell = document.getElementById(`net_${groupId}_${playerId}_${i}`);
                    
                    if (grossInput && grossInput.value) {
                        backTotal += parseInt(grossInput.value);
                    }
                    if (netCell && netCell.textContent !== '-') {
                        netBackTotal += parseInt(netCell.textContent);
                    }
                }
            }
            
            // Update display
            const frontCell = document.getElementById(`front_${groupId}_${playerId}`);
            const backCell = document.getElementById(`back_${groupId}_${playerId}`);
            const totalCell = document.getElementById(`total_${groupId}_${playerId}`);
            const netFrontCell = document.getElementById(`netfront_${groupId}_${playerId}`);
            const netBackCell = document.getElementById(`netback_${groupId}_${playerId}`);
            const netTotalCell = document.getElementById(`nettotal_${groupId}_${playerId}`);
            
            if (frontCell) frontCell.textContent = frontTotal > 0 ? frontTotal : '-';
            if (backCell) backCell.textContent = backTotal > 0 ? backTotal : '-';
            if (totalCell) totalCell.textContent = (frontTotal + backTotal) > 0 ? (frontTotal + backTotal) : '-';
            if (netFrontCell) netFrontCell.textContent = netFrontTotal > 0 ? netFrontTotal : '-';
            if (netBackCell) netBackCell.textContent = netBackTotal > 0 ? netBackTotal : '-';
            if (netTotalCell) netTotalCell.textContent = (netFrontTotal + netBackTotal) > 0 ? (netFrontTotal + netBackTotal) : '-';
        }<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brother Frank Cup</title>
    <style>
        :root {
            --garnet: #782F40;
            --gold: #CFAB00;
            --light-gold: #F5E6A8;
            --dark-garnet: #5C2430;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --gray: #CCCCCC;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--light-gray);
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, var(--garnet), var(--dark-garnet));
            color: var(--white);
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            background-color: var(--white);
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab {
            background-color: var(--light-gold);
            border: 2px solid var(--garnet);
            border-bottom: none;
            padding: 15px 20px;
            cursor: pointer;
            font-weight: bold;
            color: var(--dark-garnet);
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
            min-width: 120px;
        }

        .tab:hover {
            background-color: var(--gold);
            transform: translateY(-2px);
        }

        .tab.active {
            background-color: var(--garnet);
            color: var(--white);
            border-bottom: 2px solid var(--garnet);
        }

        .tab-content {
            display: none;
            background-color: var(--white);
            padding: 30px;
            border: 2px solid var(--garnet);
            border-radius: 10px;
            margin-top: -2px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--dark-garnet);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--garnet);
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 8px rgba(207, 171, 0, 0.3);
        }

        .btn {
            background-color: var(--garnet);
            color: var(--white);
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background-color: var(--dark-garnet);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background-color: var(--gold);
            color: var(--dark-garnet);
        }

        .btn-secondary:hover {
            background-color: #B8960A;
        }

        .btn-danger {
            background-color: #DC3545;
        }

        .btn-danger:hover {
            background-color: #C82333;
        }

        .card {
            background-color: var(--white);
            border: 2px solid var(--garnet);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: var(--garnet);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--gold);
            padding-bottom: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .scorecard-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .scorecard-table th, .scorecard-table td {
            border: 2px solid var(--garnet);
            padding: 8px;
            text-align: center;
        }

        .scorecard-table th {
            background-color: var(--garnet);
            color: var(--white);
            font-weight: bold;
        }

        .scorecard-table tbody tr:nth-child(even) {
            background-color: var(--light-gold);
        }

        .player-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid var(--garnet);
            object-fit: cover;
            margin: 0 auto;
        }

        .password-section {
            background-color: var(--light-gold);
            padding: 20px;
            border: 2px solid var(--garnet);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .admin-only {
            display: none;
        }

        .scorer-only {
            display: none;
        }

        .match-setup {
            border: 2px solid var(--garnet);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: var(--light-gold);
        }

        .team-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: var(--white);
            border: 2px solid var(--garnet);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .team-players {
            display: flex;
            gap: 10px;
        }

        .points-display {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--garnet);
        }

        .live-score-match {
            border: 2px solid var(--garnet);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: var(--white);
        }

        .mvp-section {
            background-color: var(--gold);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--garnet);
            margin-top: 20px;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .stats-table th, .stats-table td {
            border: 1px solid var(--garnet);
            padding: 10px;
            text-align: center;
        }

        .stats-table th {
            background-color: var(--garnet);
            color: var(--white);
        }

        .mobile-responsive {
            overflow-x: auto;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                flex: none;
            }
            
            .container {
                padding: 10px;
            }
            
            .scorecard-table {
                font-size: 12px;
            }
            
            .scorecard-table th, .scorecard-table td {
                padding: 4px;
            }
        }

        .hole-input {
            max-width: 60px;
            padding: 5px;
            text-align: center;
        }

        .tournament-history-link {
            background-color: var(--light-gold);
            border: 2px solid var(--garnet);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tournament-history-link:hover {
            background-color: var(--gold);
            transform: translateY(-2px);
        }

        .export-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Brother Frank Cup</h1>
        <p id="tournamentYear">2025 Tournament</p>
        <div id="connectionStatus" style="margin-top: 10px; font-size: 0.9em;">
            <span id="statusIndicator">ðŸ”„ Connecting to cloud...</span>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('course-setup')">Golf Course Setup</div>
            <div class="tab" onclick="switchTab('team-setup')">Team Setup</div>
            <div class="tab" onclick="switchTab('scorecard')">Scorecard</div>
            <div class="tab" onclick="switchTab('live-scoring')">Live Scoring</div>
            <div class="tab" onclick="switchTab('overall-scoring')">Overall Scoring</div>
            <div class="tab" onclick="switchTab('player-stats')">Player Statistics</div>
            <div class="tab" onclick="switchTab('tournament-history')">Tournament History</div>
        </div>

        <!-- Golf Course Setup Tab -->
        <div id="course-setup" class="tab-content active">
            <div class="password-section">
                <h3>Administrator Access</h3>
                <div class="form-group">
                    <label for="adminPassword">Enter Admin Password:</label>
                    <input type="password" id="adminPassword" placeholder="Enter password">
                    <button class="btn" onclick="checkAdminPassword()">Access Admin Functions</button>
                </div>
                <div id="adminError" style="color: red; margin-top: 10px; display: none;">Incorrect password</div>
            </div>

            <div id="adminSection" class="admin-only">
                <div class="card">
                    <h3>Course Information</h3>
                    <div class="form-group">
                        <label for="courseName">Course Name:</label>
                        <input type="text" id="courseName" placeholder="Enter course name">
                    </div>
                    <div class="form-group">
                        <label for="roundType">Round Type:</label>
                        <select id="roundType" onchange="updateHoleSetup()">
                            <option value="9">9 Holes</option>
                            <option value="18">18 Holes</option>
                        </select>
                    </div>
                </div>

                <div class="card">
                    <h3>Hole Setup</h3>
                    <table class="scorecard-table">
                        <thead>
                            <tr>
                                <th>Hole</th>
                                <th>Par</th>
                                <th>Handicap</th>
                            </tr>
                        </thead>
                        <tbody id="holeSetupTable">
                            <!-- Holes will be populated here -->
                        </tbody>
                    </table>
                    <button class="btn" onclick="saveHoleSetup()">Save Hole Setup</button>
                </div>

                <div class="card">
                    <h3>Match Setup</h3>
                    <div class="form-group">
                        <label for="roundName">Round Name:</label>
                        <input type="text" id="roundName" placeholder="e.g., Thursday AM, Friday PM">
                    </div>
                    <div class="form-group">
                        <label for="matchType">Match Type:</label>
                        <select id="matchType" onchange="updateMatchSetup()">
                            <option value="">Select match type...</option>
                            <option value="2v2">2 vs 2 (2 matches)</option>
                            <option value="1v1">1 vs 1 (8 matches)</option>
                            <option value="4v4">4 vs 4 Alternate Shot (1 match)</option>
                        </select>
                    </div>
                    <div id="scoringTypeContainer" style="display: none;">
                        <div class="form-group">
                            <label for="scoringType">Scoring Type (2v2 only):</label>
                            <select id="scoringType">
                                <option value="best">Best Net Score</option>
                                <option value="combined">Combined Net Score</option>
                            </select>
                        </div>
                    </div>
                    <div id="matchPairings"></div>
                    <button class="btn" onclick="saveRoundMatches()">Save Round Matches</button>
                    
                    <div id="savedRoundsDisplay" style="margin-top: 30px;">
                        <h4>Saved Rounds</h4>
                        <div id="savedRoundsList"></div>
                    </div>
                </div>

                <div class="card">
                    <h3>Group Setup</h3>
                    <div id="groupSetup"></div>
                    <button class="btn" onclick="addGroup()">Add Group</button>
                    <button class="btn btn-secondary" onclick="saveGroupSetup()">Save Groups</button>
                </div>

                <div class="card">
                    <h3>Scorekeeper Assignment</h3>
                    <div id="scorekeeperAssignment"></div>
                    <button class="btn" onclick="saveScorekeeperAssignment()">Save Assignments</button>
                </div>

                <div class="card">
                    <h3>Tournament Year</h3>
                    <div class="form-group">
                        <label for="tournamentYearInput">Tournament Year:</label>
                        <input type="number" id="tournamentYearInput" min="2020" max="2050" value="2025">
                        <button class="btn" onclick="updateTournamentYear()">Update Year</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Data Management</h3>
                    <p><strong>Multi-Device Tournament:</strong> Use these tools to transfer data between devices.</p>
                    
                    <div class="form-group">
                        <label>Export Complete Tournament Data:</label>
                        <button class="btn" onclick="exportTournamentData()">Export All Data</button>
                        <small style="display: block; margin-top: 5px; color: var(--dark-garnet);">
                            Downloads complete tournament data file for importing on other devices
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="importFile">Import Tournament Data:</label>
                        <input type="file" id="importFile" accept=".json" onchange="handleImportFile(this)">
                        <small style="display: block; margin-top: 5px; color: var(--dark-garnet);">
                            Upload tournament data file exported from another device
                        </small>
                    </div>

                    <div class="form-group">
                        <label>Quick Sync Instructions:</label>
                        <div style="background-color: var(--light-gold); padding: 15px; border-radius: 5px; border: 1px solid var(--garnet);">
                            <strong>On-Course Scoring Solution:</strong><br>
                            1. Export data from laptop before going to course<br>
                            2. Import data file on phone/tablet at course<br>
                            3. Enter scores on mobile devices<br>
                            4. Export data from phone after round<br>
                            5. Import updated data back to laptop<br>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Setup Tab -->
        <div id="team-setup" class="tab-content">
            <div class="password-section">
                <h3>Administrator Access Required</h3>
                <p>Please login as administrator in the Golf Course Setup tab first.</p>
            </div>

            <div id="teamSetupSection" class="admin-only">
                <div class="grid">
                    <div class="card">
                        <h3>Team 1</h3>
                        <div class="form-group">
                            <label for="team1Name">Team Name:</label>
                            <input type="text" id="team1Name" placeholder="Enter team 1 name">
                        </div>
                        <div id="team1Players"></div>
                        <button class="btn" onclick="addPlayer(1)">Add Player</button>
                        <button class="btn btn-secondary" onclick="saveTeam(1)">Save Team 1</button>
                    </div>

                    <div class="card">
                        <h3>Team 2</h3>
                        <div class="form-group">
                            <label for="team2Name">Team Name:</label>
                            <input type="text" id="team2Name" placeholder="Enter team 2 name">
                        </div>
                        <div id="team2Players"></div>
                        <button class="btn" onclick="addPlayer(2)">Add Player</button>
                        <button class="btn btn-secondary" onclick="saveTeam(2)">Save Team 2</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scorecard Tab -->
        <div id="scorecard" class="tab-content">
            <div class="password-section">
                <h3>Scorer Access</h3>
                <div class="form-group">
                    <label for="scorerPassword">Enter Scoring Password:</label>
                    <input type="password" id="scorerPassword" placeholder="Enter password">
                    <button class="btn" onclick="checkScorerPassword()">Access Scoring</button>
                </div>
                <div id="scorerError" style="color: red; margin-top: 10px; display: none;">Incorrect password</div>
            </div>

            <div id="scoringSection" class="scorer-only">
                <div class="card">
                    <h3>Select Group to Score</h3>
                    <div class="form-group">
                        <label for="groupSelect">Select Group:</label>
                        <select id="groupSelect" onchange="loadScorecard()">
                            <option value="">Select a group...</option>
                        </select>
                    </div>
                </div>

                <div id="scorecardDisplay"></div>
            </div>
        </div>

        <!-- Live Scoring Tab -->
        <div id="live-scoring" class="tab-content">
            <h2>Live Match Scoring</h2>
            <div id="liveScoreDisplay"></div>
        </div>

        <!-- Overall Scoring Tab -->
        <div id="overall-scoring" class="tab-content">
            <h2>Overall Tournament Scoring</h2>
            <button class="btn export-btn" onclick="exportOverallScoring()">Export</button>
            
            <div class="card">
                <h3>Team Totals</h3>
                <div class="team-display">
                    <div>
                        <h4 id="team1NameDisplay">Team 1</h4>
                        <div class="points-display" id="team1TotalPoints">0</div>
                    </div>
                    <div style="text-align: center;">
                        <p>221 Points Needed to Win</p>
                        <p><strong>Total Available: 440 Points</strong></p>
                    </div>
                    <div>
                        <h4 id="team2NameDisplay">Team 2</h4>
                        <div class="points-display" id="team2TotalPoints">0</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Round Results</h3>
                <div id="roundResults"></div>
            </div>

            <div class="mvp-section admin-only">
                <h3>MVP Selection (Admin Only)</h3>
                <div class="form-group">
                    <label for="mvpSelect">Select MVP:</label>
                    <select id="mvpSelect"></select>
                    <button class="btn" onclick="selectMVP()">Select MVP</button>
                </div>
                <div id="mvpLeaderboard"></div>
            </div>
        </div>

        <!-- Player Statistics Tab -->
        <div id="player-stats" class="tab-content">
            <h2>Player Statistics</h2>
            <button class="btn export-btn" onclick="exportPlayerStats()">Export</button>
            <div id="playerStatsDisplay"></div>
        </div>

        <!-- Tournament History Tab -->
        <div id="tournament-history" class="tab-content">
            <h2>Tournament History</h2>
            
            <div class="card admin-only">
                <h3>Finalize Tournament (Admin Only)</h3>
                <button class="btn btn-danger" onclick="finalizeTournament()">Finalize Tournament</button>
                <p style="margin-top: 10px; color: var(--dark-garnet);">
                    <strong>Warning:</strong> This will save all current results to tournament history and cannot be undone.
                </p>
            </div>

            <div id="tournamentHistoryDisplay"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBN2oj0ud2FEdUEJ8CH39DkCOA1zKU9PaI",
            authDomain: "brotherfrankcup.firebaseapp.com",
            databaseURL: "https://brotherfrankcup-default-rtdb.firebaseio.com/",
            projectId: "brotherfrankcup",
            storageBucket: "brotherfrankcup.firebasestorage.app",
            messagingSenderId: "857568799868",
            appId: "1:857568799868:web:9afeadb401b3e77d3aadf9"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global variables
        let currentUser = null;
        let teams = {1: {name: '', players: []}, 2: {name: '', players: []}};
        let courseData = {name: '', holes: [], roundType: 18};
        let matches = [];
        let groups = [];
        let scorecards = {};
        let tournamentData = {};
        let tournamentYear = 2025;

        // Connection status management
        function updateConnectionStatus(status, message) {
            const indicator = document.getElementById('statusIndicator');
            if (indicator) {
                switch(status) {
                    case 'connected':
                        indicator.innerHTML = 'âœ… Connected - Real-time sync active';
                        indicator.style.color = '#28a745';
                        break;
                    case 'disconnected':
                        indicator.innerHTML = 'âŒ Offline - Using local storage';
                        indicator.style.color = '#dc3545';
                        break;
                    case 'connecting':
                        indicator.innerHTML = 'ðŸ”„ Connecting to cloud...';
                        indicator.style.color = '#ffc107';
                        break;
                    case 'error':
                        indicator.innerHTML = 'âš ï¸ Connection error - Using local backup';
                        indicator.style.color = '#fd7e14';
                        break;
                }
            }
        }

        // Enhanced Firebase functions with status updates
        function saveToFirebase() {
            const data = {
                teams, courseData, matches, groups, scorecards, tournamentData, tournamentYear,
                tournamentRounds: window.tournamentRounds || [],
                lastUpdated: new Date().toISOString()
            };
            
            updateConnectionStatus('connecting', 'Saving data...');
            
            database.ref('tournament').set(data)
                .then(() => {
                    console.log('Data saved to Firebase successfully');
                    updateConnectionStatus('connected', 'Data saved successfully');
                })
                .catch((error) => {
                    console.error('Error saving to Firebase:', error);
                    updateConnectionStatus('error', 'Save failed, using local backup');
                    // Fall back to localStorage
                    localStorage.setItem('brotherFrankCupData', JSON.stringify(data));
                });
        }

        function loadFromFirebase() {
            return new Promise((resolve, reject) => {
                updateConnectionStatus('connecting', 'Loading tournament data...');
                
                // Check connection first
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', (snapshot) => {
                    if (snapshot.val() === true) {
                        updateConnectionStatus('connected', 'Connected to Firebase');
                    } else {
                        updateConnectionStatus('disconnected', 'No internet connection');
                    }
                });

                database.ref('tournament').once('value')
                    .then((snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            teams = data.teams || {1: {name: '', players: []}, 2: {name: '', players: []}};
                            courseData = data.courseData || {name: '', holes: [], roundType: 18};
                            matches = data.matches || [];
                            groups = data.groups || [];
                            scorecards = data.scorecards || {};
                            tournamentData = data.tournamentData || {};
                            tournamentYear = data.tournamentYear || 2025;
                            window.tournamentRounds = data.tournamentRounds || [];
                            console.log('Data loaded from Firebase successfully');
                            updateConnectionStatus('connected', 'Tournament data loaded from cloud');
                        } else {
                            console.log('No cloud data found, checking local storage');
                            loadFromLocalStorage();
                            updateConnectionStatus('connected', 'Connected - No cloud data found');
                        }
                        resolve(data);
                    })
                    .catch((error) => {
                        console.error('Error loading from Firebase:', error);
                        updateConnectionStatus('error', 'Failed to load from cloud');
                        // Fall back to localStorage
                        loadFromLocalStorage();
                        reject(error);
                    });
            });
        }

        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem('brotherFrankCupData');
                if (stored) {
                    const data = JSON.parse(stored);
                    teams = data.teams || {1: {name: '', players: []}, 2: {name: '', players: []}};
                    courseData = data.courseData || {name: '', holes: [], roundType: 18};
                    matches = data.matches || [];
                    groups = data.groups || [];
                    scorecards = data.scorecards || {};
                    tournamentData = data.tournamentData || {};
                    tournamentYear = data.tournamentYear || 2025;
                    window.tournamentRounds = data.tournamentRounds || [];
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
        }

        // Listen for real-time updates
        function setupRealtimeListeners() {
            // Listen for scorecard updates
            database.ref('tournament/scorecards').on('value', (snapshot) => {
                const newScorecards = snapshot.val();
                if (newScorecards && JSON.stringify(newScorecards) !== JSON.stringify(scorecards)) {
                    scorecards = newScorecards;
                    updateLiveScoring();
                    console.log('Scorecards updated from Firebase');
                }
            });

            // Listen for tournament data updates
            database.ref('tournament').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.lastUpdated) {
                    // Only update if this is a newer update (prevent infinite loops)
                    const currentTime = new Date().toISOString();
                    if (data.lastUpdated !== currentTime) {
                        // Update local data without triggering another save
                        teams = data.teams || teams;
                        courseData = data.courseData || courseData;
                        matches = data.matches || matches;
                        groups = data.groups || groups;
                        tournamentData = data.tournamentData || tournamentData;
                        tournamentYear = data.tournamentYear || tournamentYear;
                        window.tournamentRounds = data.tournamentRounds || window.tournamentRounds;
                        
                        updateDisplaysQuiet();
                    }
                }
            });
        }

        // Update displays without triggering Firebase saves
        function updateDisplaysQuiet() {
            try {
                if (currentUser === 'admin') {
                    updateHoleSetup();
                    updateScorekeeperAssignment();
                    displaySavedRounds();
                    updateOverallScoring();
                    updatePlayerStatistics();
                    updateTournamentHistory();
                }
                
                if (currentUser === 'scorer' || currentUser === 'admin') {
                    updateLiveScoring();
                }
            } catch (error) {
                console.error('Error updating displays:', error);
            }
        }

        // Initialize the application
        function initializeApp() {
            loadStoredData();
            updateHoleSetup();
            updateTournamentYear();
        }

        // Load data from storage
        function loadStoredData() {
            const stored = localStorage.getItem('brotherFrankCupData');
            if (stored) {
                const data = JSON.parse(stored);
                teams = data.teams || {1: {name: '', players: []}, 2: {name: '', players: []}};
                courseData = data.courseData || {name: '', holes: [], roundType: 18};
                matches = data.matches || [];
                groups = data.groups || [];
                scorecards = data.scorecards || {};
                tournamentData = data.tournamentData || {};
                tournamentYear = data.tournamentYear || 2025;
                window.tournamentRounds = data.tournamentRounds || [];
            }
            updateDisplays();
        }

        // Save data to storage
        function saveData() {
            const data = {
                teams, courseData, matches, groups, scorecards, tournamentData, tournamentYear,
                tournamentRounds: window.tournamentRounds || []
            };
            localStorage.setItem('brotherFrankCupData', JSON.stringify(data));
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Update displays when switching tabs
            updateDisplays();
        }

        // Password checking
        function checkAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            if (password === 'Pikes1623') {
                currentUser = 'admin';
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                document.getElementById('adminError').style.display = 'none';
                updateDisplays();
            } else {
                document.getElementById('adminError').style.display = 'block';
            }
        }

        function checkScorerPassword() {
            const password = document.getElementById('scorerPassword').value;
            if (password === 'PikesGolf') {
                currentUser = 'scorer';
                document.querySelectorAll('.scorer-only').forEach(el => el.style.display = 'block');
                document.getElementById('scorerError').style.display = 'none';
                updateGroupSelect();
            } else {
                document.getElementById('scorerError').style.display = 'block';
            }
        }

        // Course setup functions
        function updateHoleSetup() {
            const roundType = document.getElementById('roundType').value;
            const holes = parseInt(roundType);
            const table = document.getElementById('holeSetupTable');
            table.innerHTML = '';

            // Default par and handicap values for 18 holes
            const defaultPars = [4,5,4,3,4,5,4,3,4,4,3,5,4,4,4,5,3,4];
            const defaultHandicaps = [5,11,1,13,17,15,3,7,9,8,16,10,4,2,18,12,14,6];

            for (let i = 1; i <= holes; i++) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${i}</td>
                    <td><input type="number" id="par${i}" value="${defaultPars[i-1] || 4}" min="3" max="5" class="hole-input"></td>
                    <td><input type="number" id="handicap${i}" value="${defaultHandicaps[i-1] || i}" min="1" max="18" class="hole-input"></td>
                `;
                table.appendChild(row);
            }
        }

        function saveHoleSetup() {
            const roundType = document.getElementById('roundType').value;
            const holes = parseInt(roundType);
            const courseName = document.getElementById('courseName').value;
            
            courseData = {
                name: courseName,
                roundType: holes,
                holes: []
            };

            for (let i = 1; i <= holes; i++) {
                courseData.holes.push({
                    number: i,
                    par: parseInt(document.getElementById(`par${i}`).value),
                    handicap: parseInt(document.getElementById(`handicap${i}`).value)
                });
            }

            saveData();
            alert('Course setup saved successfully!');
        }

        // Team setup functions
        function addPlayer(teamNum) {
            const playerId = Date.now();
            const playerDiv = document.createElement('div');
            playerDiv.className = 'form-group';
            playerDiv.id = `player${teamNum}_${playerId}`;
            playerDiv.innerHTML = `
                <div style="border: 2px solid var(--garnet); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                    <label>Player Name:</label>
                    <input type="text" id="name${teamNum}_${playerId}" placeholder="Enter player name">
                    <label>Handicap:</label>
                    <input type="number" id="handicap${teamNum}_${playerId}" placeholder="Enter handicap" min="0" max="54">
                    <label>Player Photo (optional):</label>
                    <input type="file" id="photo${teamNum}_${playerId}" accept="image/*" onchange="handlePhotoUpload(${teamNum}, ${playerId})">
                    <button class="btn btn-danger" onclick="removePlayer(${teamNum}, ${playerId})">Delete Player</button>
                    <button class="btn btn-secondary" onclick="editPlayer(${teamNum}, ${playerId})">Edit Player</button>
                </div>
            `;
            document.getElementById(`team${teamNum}Players`).appendChild(playerDiv);
        }

        function removePlayer(teamNum, playerId) {
            document.getElementById(`player${teamNum}_${playerId}`).remove();
        }

        function editPlayer(teamNum, playerId) {
            // Implementation for editing player details
            alert('Edit functionality - modify player details as needed');
        }

        function handlePhotoUpload(teamNum, playerId) {
            const fileInput = document.getElementById(`photo${teamNum}_${playerId}`);
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Store photo data (in real implementation, would upload to server)
                    const photoData = e.target.result;
                    // Store in player data
                };
                reader.readAsDataURL(file);
            }
        }

        function saveTeam(teamNum) {
            const teamName = document.getElementById(`team${teamNum}Name`).value;
            const playerElements = document.querySelectorAll(`#team${teamNum}Players .form-group`);
            
            teams[teamNum] = {
                name: teamName,
                players: []
            };

            playerElements.forEach(element => {
                const playerId = element.id.split('_')[1];
                const name = document.getElementById(`name${teamNum}_${playerId}`)?.value;
                const handicap = document.getElementById(`handicap${teamNum}_${playerId}`)?.value;
                
                if (name && handicap) {
                    teams[teamNum].players.push({
                        id: playerId,
                        name: name,
                        handicap: parseInt(handicap),
                        photo: null // In real implementation, would store photo data
                    });
                }
            });

            saveData();
            alert(`Team ${teamNum} saved successfully!`);
            updateDisplays();
        }

        // Match setup functions
        function updateMatchSetup() {
            const matchType = document.getElementById('matchType').value;
            const pairingsDiv = document.getElementById('matchPairings');
            const scoringContainer = document.getElementById('scoringTypeContainer');
            
            if (!matchType) {
                pairingsDiv.innerHTML = '';
                scoringContainer.style.display = 'none';
                return;
            }
            
            if (matchType === '2v2') {
                scoringContainer.style.display = 'block';
                pairingsDiv.innerHTML = `
                    <h4>2 vs 2 Matches (2 matches per round)</h4>
                    <div id="match2v2Setup"></div>
                `;
                // Create exactly 2 matches for 2v2
                for (let i = 0; i < 2; i++) {
                    add2v2Match();
                }
            } else if (matchType === '1v1') {
                scoringContainer.style.display = 'none';
                pairingsDiv.innerHTML = `
                    <h4>1 vs 1 Matches (8 matches per round)</h4>
                    <div id="match1v1Setup"></div>
                `;
                // Create exactly 8 matches for 1v1
                for (let i = 0; i < 8; i++) {
                    add1v1Match();
                }
            } else if (matchType === '4v4') {
                scoringContainer.style.display = 'none';
                pairingsDiv.innerHTML = `
                    <h4>4 vs 4 Alternate Shot (1 match per round)</h4>
                    <div class="form-group">
                        <label>Team 1 Handicap:</label>
                        <input type="number" id="team1AltShotHandicap" min="0" max="100" placeholder="Enter team handicap">
                    </div>
                    <div class="form-group">
                        <label>Team 2 Handicap:</label>
                        <input type="number" id="team2AltShotHandicap" min="0" max="100" placeholder="Enter team handicap">
                    </div>
                    <p><strong>Note:</strong> All 4 players from each team participate in alternate shot format.</p>
                `;
            }
        }

        function add2v2Match() {
            const matchId = Date.now() + Math.random(); // Ensure unique IDs
            const setupDiv = document.getElementById('match2v2Setup');
            const matchNumber = setupDiv.children.length + 1;
            
            const matchDiv = document.createElement('div');
            matchDiv.className = 'match-setup';
            matchDiv.innerHTML = `
                <h5>Match ${matchNumber}</h5>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="border: 2px solid var(--garnet); padding: 15px; border-radius: 10px;">
                        <h6>Team 1 Players</h6>
                        <div class="form-group">
                            <label>Player 1:</label>
                            <select id="team1Player1_${matchId}"></select>
                        </div>
                        <div class="form-group">
                            <label>Player 2:</label>
                            <select id="team1Player2_${matchId}"></select>
                        </div>
                    </div>
                    <div style="border: 2px solid var(--garnet); padding: 15px; border-radius: 10px;">
                        <h6>Team 2 Players</h6>
                        <div class="form-group">
                            <label>Player 1:</label>
                            <select id="team2Player1_${matchId}"></select>
                        </div>
                        <div class="form-group">
                            <label>Player 2:</label>
                            <select id="team2Player2_${matchId}"></select>
                        </div>
                    </div>
                </div>
                <p style="text-align: center; margin-top: 10px; font-style: italic;">
                    ${document.getElementById('team1Player1_' + matchId) ? teams[1].name || 'Team 1' : 'Team 1'} vs ${document.getElementById('team2Player1_' + matchId) ? teams[2].name || 'Team 2' : 'Team 2'}
                </p>
            `;
            setupDiv.appendChild(matchDiv);
            populatePlayerDropdowns(matchId);
        }

        function add1v1Match() {
            const matchId = Date.now() + Math.random(); // Ensure unique IDs
            const setupDiv = document.getElementById('match1v1Setup');
            const matchNumber = setupDiv.children.length + 1;
            
            const matchDiv = document.createElement('div');
            matchDiv.className = 'match-setup';
            matchDiv.innerHTML = `
                <h5>Match ${matchNumber}</h5>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="border: 2px solid var(--garnet); padding: 15px; border-radius: 10px;">
                        <h6>Team 1 Player</h6>
                        <div class="form-group">
                            <select id="team1Player_${matchId}"></select>
                        </div>
                    </div>
                    <div style="border: 2px solid var(--garnet); padding: 15px; border-radius: 10px;">
                        <h6>Team 2 Player</h6>
                        <div class="form-group">
                            <select id="team2Player_${matchId}"></select>
                        </div>
                    </div>
                </div>
                <p style="text-align: center; margin-top: 10px; font-style: italic;">
                    ${teams[1].name || 'Team 1'} vs ${teams[2].name || 'Team 2'}
                </p>
            `;
            setupDiv.appendChild(matchDiv);
            populatePlayerDropdowns(matchId);
        }

        function populatePlayerDropdowns(matchId) {
            // Populate dropdowns with team players
            const team1Selects = document.querySelectorAll(`[id*="team1"][id*="${matchId}"]`);
            const team2Selects = document.querySelectorAll(`[id*="team2"][id*="${matchId}"]`);

            team1Selects.forEach(select => {
                select.innerHTML = '<option value="">Select player...</option>';
                if (teams[1] && teams[1].players) {
                    teams[1].players.forEach(player => {
                        select.innerHTML += `<option value="${player.id}">${player.name} (HCP: ${player.handicap})</option>`;
                    });
                }
            });

            team2Selects.forEach(select => {
                select.innerHTML = '<option value="">Select player...</option>';
                if (teams[2] && teams[2].players) {
                    teams[2].players.forEach(player => {
                        select.innerHTML += `<option value="${player.id}">${player.name} (HCP: ${player.handicap})</option>`;
                    });
                }
            });
        }

        function saveRoundMatches() {
            const roundName = document.getElementById('roundName').value.trim();
            const matchType = document.getElementById('matchType').value;
            
            if (!roundName) {
                alert('Please enter a round name (e.g., Thursday AM, Friday PM)');
                return;
            }
            
            if (!matchType) {
                alert('Please select a match type');
                return;
            }
            
            // Initialize rounds array if it doesn't exist
            if (!window.tournamentRounds) {
                window.tournamentRounds = [];
            }
            
            const roundData = {
                id: Date.now(),
                name: roundName,
                type: matchType,
                matches: [],
                scoringType: matchType === '2v2' ? document.getElementById('scoringType').value : null
            };
            
            if (matchType === '2v2') {
                const matchDivs = document.querySelectorAll('#match2v2Setup .match-setup');
                matchDivs.forEach((div, index) => {
                    const matchId = div.querySelector('select').id.split('_')[1];
                    const team1Player1 = document.getElementById(`team1Player1_${matchId}`)?.value;
                    const team1Player2 = document.getElementById(`team1Player2_${matchId}`)?.value;
                    const team2Player1 = document.getElementById(`team2Player1_${matchId}`)?.value;
                    const team2Player2 = document.getElementById(`team2Player2_${matchId}`)?.value;
                    
                    if (team1Player1 && team1Player2 && team2Player1 && team2Player2) {
                        roundData.matches.push({
                            type: '2v2',
                            matchNumber: index + 1,
                            team1: [team1Player1, team1Player2],
                            team2: [team2Player1, team2Player2],
                            team1Names: [getPlayerById(team1Player1)?.name, getPlayerById(team1Player2)?.name],
                            team2Names: [getPlayerById(team2Player1)?.name, getPlayerById(team2Player2)?.name]
                        });
                    }
                });
                
                if (roundData.matches.length !== 2) {
                    alert('Please complete all 2 matches for 2v2 round');
                    return;
                }
                
            } else if (matchType === '1v1') {
                const matchDivs = document.querySelectorAll('#match1v1Setup .match-setup');
                matchDivs.forEach((div, index) => {
                    const matchId = div.querySelector('select').id.split('_')[1];
                    const team1Player = document.getElementById(`team1Player_${matchId}`)?.value;
                    const team2Player = document.getElementById(`team2Player_${matchId}`)?.value;
                    
                    if (team1Player && team2Player) {
                        roundData.matches.push({
                            type: '1v1',
                            matchNumber: index + 1,
                            team1: [team1Player],
                            team2: [team2Player],
                            team1Names: [getPlayerById(team1Player)?.name],
                            team2Names: [getPlayerById(team2Player)?.name]
                        });
                    }
                });
                
                if (roundData.matches.length !== 8) {
                    alert('Please complete all 8 matches for 1v1 round');
                    return;
                }
                
            } else if (matchType === '4v4') {
                const team1Handicap = document.getElementById('team1AltShotHandicap').value;
                const team2Handicap = document.getElementById('team2AltShotHandicap').value;
                
                if (!team1Handicap || !team2Handicap) {
                    alert('Please enter handicaps for both teams');
                    return;
                }
                
                roundData.matches.push({
                    type: '4v4',
                    matchNumber: 1,
                    team1Handicap: parseInt(team1Handicap),
                    team2Handicap: parseInt(team2Handicap),
                    team1: teams[1].players.map(p => p.id),
                    team2: teams[2].players.map(p => p.id),
                    team1Names: teams[1].players.map(p => p.name),
                    team2Names: teams[2].players.map(p => p.name)
                });
            }
            
            // Save the round
            window.tournamentRounds.push(roundData);
            
            // Update matches array for compatibility
            matches = matches.concat(roundData.matches);
            
            saveData();
            displaySavedRounds();
            
            // Clear the form
            document.getElementById('roundName').value = '';
            document.getElementById('matchType').value = '';
            updateMatchSetup();
            
            alert(`Round "${roundName}" saved successfully with ${roundData.matches.length} matches!`);
        }

        function displaySavedRounds() {
            const displayDiv = document.getElementById('savedRoundsList');
            
            if (!window.tournamentRounds || window.tournamentRounds.length === 0) {
                displayDiv.innerHTML = '<p>No rounds saved yet.</p>';
                return;
            }
            
            let html = '';
            window.tournamentRounds.forEach((round, roundIndex) => {
                html += `
                    <div class="card" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h5>${round.name} (${round.type.toUpperCase()})</h5>
                            <div>
                                <button class="btn btn-secondary" onclick="editRound(${roundIndex})" style="margin-right: 10px;">Edit Round</button>
                                <button class="btn btn-danger" onclick="deleteRound(${roundIndex})">Delete Round</button>
                            </div>
                        </div>
                        ${round.scoringType ? `<p><strong>Scoring:</strong> ${round.scoringType === 'best' ? 'Best Net Score' : 'Combined Net Score'}</p>` : ''}
                        <div style="margin-top: 10px;">
                `;
                
                round.matches.forEach(match => {
                    if (match.type === '2v2') {
                        html += `
                            <div style="border-left: 4px solid var(--garnet); padding-left: 10px; margin-bottom: 8px;">
                                <strong>Match ${match.matchNumber}:</strong> 
                                ${match.team1Names.join(' & ')} vs ${match.team2Names.join(' & ')}
                            </div>
                        `;
                    } else if (match.type === '1v1') {
                        html += `
                            <div style="border-left: 4px solid var(--garnet); padding-left: 10px; margin-bottom: 8px;">
                                <strong>Match ${match.matchNumber}:</strong> 
                                ${match.team1Names[0]} vs ${match.team2Names[0]}
                            </div>
                        `;
                    } else if (match.type === '4v4') {
                        html += `
                            <div style="border-left: 4px solid var(--garnet); padding-left: 10px; margin-bottom: 8px;">
                                <strong>Alternate Shot:</strong> 
                                ${teams[1].name} (HCP: ${match.team1Handicap}) vs ${teams[2].name} (HCP: ${match.team2Handicap})
                            </div>
                        `;
                    }
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            displayDiv.innerHTML = html;
        }

        function editRound(roundIndex) {
            const round = window.tournamentRounds[roundIndex];
            
            if (!round) {
                alert('Round not found');
                return;
            }
            
            // Populate the form with existing round data
            document.getElementById('roundName').value = round.name;
            document.getElementById('matchType').value = round.type;
            
            if (round.scoringType) {
                document.getElementById('scoringType').value = round.scoringType;
            }
            
            // Update the match setup to show current round type
            updateMatchSetup();
            
            // Wait for the DOM to update, then populate the match data
            setTimeout(() => {
                populateExistingMatches(round);
            }, 100);
            
            // Store the round index being edited
            window.editingRoundIndex = roundIndex;
            
            // Update the save button to show it's editing
            const saveButton = document.querySelector('button[onclick="saveRoundMatches()"]');
            if (saveButton) {
                saveButton.textContent = 'Update Round Matches';
                saveButton.style.backgroundColor = 'var(--gold)';
                saveButton.style.color = 'var(--dark-garnet)';
            }
            
            // Scroll to the match setup area
            document.getElementById('matchPairings').scrollIntoView({ behavior: 'smooth' });
            
            alert(`Now editing "${round.name}". Make your changes and click "Update Round Matches" to save.`);
        }

        function populateExistingMatches(round) {
            if (round.type === '2v2') {
                const matchDivs = document.querySelectorAll('#match2v2Setup .match-setup');
                round.matches.forEach((match, index) => {
                    if (matchDivs[index]) {
                        const matchId = matchDivs[index].querySelector('select').id.split('_')[1];
                        
                        // Populate Team 1 players
                        const team1Player1Select = document.getElementById(`team1Player1_${matchId}`);
                        const team1Player2Select = document.getElementById(`team1Player2_${matchId}`);
                        if (team1Player1Select) team1Player1Select.value = match.team1[0] || '';
                        if (team1Player2Select) team1Player2Select.value = match.team1[1] || '';
                        
                        // Populate Team 2 players
                        const team2Player1Select = document.getElementById(`team2Player1_${matchId}`);
                        const team2Player2Select = document.getElementById(`team2Player2_${matchId}`);
                        if (team2Player1Select) team2Player1Select.value = match.team2[0] || '';
                        if (team2Player2Select) team2Player2Select.value = match.team2[1] || '';
                    }
                });
            } else if (round.type === '1v1') {
                const matchDivs = document.querySelectorAll('#match1v1Setup .match-setup');
                round.matches.forEach((match, index) => {
                    if (matchDivs[index]) {
                        const matchId = matchDivs[index].querySelector('select').id.split('_')[1];
                        
                        // Populate players
                        const team1PlayerSelect = document.getElementById(`team1Player_${matchId}`);
                        const team2PlayerSelect = document.getElementById(`team2Player_${matchId}`);
                        if (team1PlayerSelect) team1PlayerSelect.value = match.team1[0] || '';
                        if (team2PlayerSelect) team2PlayerSelect.value = match.team2[0] || '';
                    }
                });
            } else if (round.type === '4v4') {
                // Populate team handicaps
                const team1HandicapInput = document.getElementById('team1AltShotHandicap');
                const team2HandicapInput = document.getElementById('team2AltShotHandicap');
                if (team1HandicapInput && round.matches[0]) team1HandicapInput.value = round.matches[0].team1Handicap || '';
                if (team2HandicapInput && round.matches[0]) team2HandicapInput.value = round.matches[0].team2Handicap || '';
            }
        }

        function saveRoundMatches() {
            const roundName = document.getElementById('roundName').value.trim();
            const matchType = document.getElementById('matchType').value;
            
            if (!roundName) {
                alert('Please enter a round name (e.g., Thursday AM, Friday PM)');
                return;
            }
            
            if (!matchType) {
                alert('Please select a match type');
                return;
            }
            
            // Initialize rounds array if it doesn't exist
            if (!window.tournamentRounds) {
                window.tournamentRounds = [];
            }
            
            const roundData = {
                id: window.editingRoundIndex !== undefined ? window.tournamentRounds[window.editingRoundIndex].id : Date.now(),
                name: roundName,
                type: matchType,
                matches: [],
                scoringType: matchType === '2v2' ? document.getElementById('scoringType').value : null
            };
            
            if (matchType === '2v2') {
                const matchDivs = document.querySelectorAll('#match2v2Setup .match-setup');
                matchDivs.forEach((div, index) => {
                    const matchId = div.querySelector('select').id.split('_')[1];
                    const team1Player1 = document.getElementById(`team1Player1_${matchId}`)?.value;
                    const team1Player2 = document.getElementById(`team1Player2_${matchId}`)?.value;
                    const team2Player1 = document.getElementById(`team2Player1_${matchId}`)?.value;
                    const team2Player2 = document.getElementById(`team2Player2_${matchId}`)?.value;
                    
                    if (team1Player1 && team1Player2 && team2Player1 && team2Player2) {
                        roundData.matches.push({
                            type: '2v2',
                            matchNumber: index + 1,
                            team1: [team1Player1, team1Player2],
                            team2: [team2Player1, team2Player2],
                            team1Names: [getPlayerById(team1Player1)?.name, getPlayerById(team1Player2)?.name],
                            team2Names: [getPlayerById(team2Player1)?.name, getPlayerById(team2Player2)?.name]
                        });
                    }
                });
                
                if (roundData.matches.length !== 2) {
                    alert('Please complete all 2 matches for 2v2 round');
                    return;
                }
                
            } else if (matchType === '1v1') {
                const matchDivs = document.querySelectorAll('#match1v1Setup .match-setup');
                matchDivs.forEach((div, index) => {
                    const matchId = div.querySelector('select').id.split('_')[1];
                    const team1Player = document.getElementById(`team1Player_${matchId}`)?.value;
                    const team2Player = document.getElementById(`team2Player_${matchId}`)?.value;
                    
                    if (team1Player && team2Player) {
                        roundData.matches.push({
                            type: '1v1',
                            matchNumber: index + 1,
                            team1: [team1Player],
                            team2: [team2Player],
                            team1Names: [getPlayerById(team1Player)?.name],
                            team2Names: [getPlayerById(team2Player)?.name]
                        });
                    }
                });
                
                if (roundData.matches.length !== 8) {
                    alert('Please complete all 8 matches for 1v1 round');
                    return;
                }
                
            } else if (matchType === '4v4') {
                const team1Handicap = document.getElementById('team1AltShotHandicap').value;
                const team2Handicap = document.getElementById('team2AltShotHandicap').value;
                
                if (!team1Handicap || !team2Handicap) {
                    alert('Please enter handicaps for both teams');
                    return;
                }
                
                roundData.matches.push({
                    type: '4v4',
                    matchNumber: 1,
                    team1Handicap: parseInt(team1Handicap),
                    team2Handicap: parseInt(team2Handicap),
                    team1: teams[1].players.map(p => p.id),
                    team2: teams[2].players.map(p => p.id),
                    team1Names: teams[1].players.map(p => p.name),
                    team2Names: teams[2].players.map(p => p.name)
                });
            }
            
            // Save or update the round
            if (window.editingRoundIndex !== undefined) {
                // Update existing round
                window.tournamentRounds[window.editingRoundIndex] = roundData;
                alert(`Round "${roundName}" updated successfully!`);
            } else {
                // Add new round
                window.tournamentRounds.push(roundData);
                alert(`Round "${roundName}" saved successfully with ${roundData.matches.length} matches!`);
            }
            
            // Update matches array for compatibility
            matches = [];
            window.tournamentRounds.forEach(round => {
                matches = matches.concat(round.matches);
            });
            
            saveData();
            displaySavedRounds();
            
            // Clear the form and reset the save button
            document.getElementById('roundName').value = '';
            document.getElementById('matchType').value = '';
            updateMatchSetup();
            
            // Reset the save button
            const saveButton = document.querySelector('button[onclick="saveRoundMatches()"]');
            if (saveButton) {
                saveButton.textContent = 'Save Round Matches';
                saveButton.style.backgroundColor = 'var(--garnet)';
                saveButton.style.color = 'var(--white)';
            }
            
            // Clear the editing state
            window.editingRoundIndex = undefined;
        }

        // Group setup functions
        function addGroup() {
            const groupId = Date.now();
            const groupDiv = document.createElement('div');
            groupDiv.className = 'match-setup';
            groupDiv.innerHTML = `
                <h5>Group ${groups.length + 1}</h5>
                <div class="form-group">
                    <label>Player 1:</label>
                    <select id="groupPlayer1_${groupId}"></select>
                </div>
                <div class="form-group">
                    <label>Player 2:</label>
                    <select id="groupPlayer2_${groupId}"></select>
                </div>
                <div class="form-group">
                    <label>Player 3:</label>
                    <select id="groupPlayer3_${groupId}"></select>
                </div>
                <div class="form-group">
                    <label>Player 4:</label>
                    <select id="groupPlayer4_${groupId}"></select>
                </div>
                <button class="btn btn-danger" onclick="removeGroup(this, '${groupId}')">Remove Group</button>
            `;
            document.getElementById('groupSetup').appendChild(groupDiv);
            populateGroupPlayerDropdowns(groupId);
        }

        function populateGroupPlayerDropdowns(groupId) {
            for (let i = 1; i <= 4; i++) {
                const select = document.getElementById(`groupPlayer${i}_${groupId}`);
                select.innerHTML = '<option value="">Select player...</option>';
                
                // Add all players from both teams
                teams[1].players.forEach(player => {
                    select.innerHTML += `<option value="${player.id}">${player.name} (Team 1, ${player.handicap})</option>`;
                });
                teams[2].players.forEach(player => {
                    select.innerHTML += `<option value="${player.id}">${player.name} (Team 2, ${player.handicap})</option>`;
                });
            }
        }

        function removeGroup(button, groupId) {
            button.parentElement.remove();
            groups = groups.filter(g => g.id !== groupId);
        }

        function saveGroupSetup() {
            groups = [];
            const groupDivs = document.querySelectorAll('#groupSetup .match-setup');
            
            groupDivs.forEach((div, index) => {
                const groupId = div.querySelector('select').id.split('_')[1];
                const players = [];
                
                for (let i = 1; i <= 4; i++) {
                    const playerId = document.getElementById(`groupPlayer${i}_${groupId}`).value;
                    if (playerId) {
                        players.push(playerId);
                    }
                }
                
                if (players.length === 4) {
                    groups.push({
                        id: groupId,
                        players: players,
                        name: `Group ${index + 1}`,
                        scorekeeper: null
                    });
                }
            });

            saveData();
            alert('Group setup saved successfully!');
            updateGroupSelect();
            updateScorekeeperAssignment();
        }

        // Scorekeeper assignment
        function updateScorekeeperAssignment() {
            const assignmentDiv = document.getElementById('scorekeeperAssignment');
            
            if (groups.length === 0) {
                assignmentDiv.innerHTML = '<p>Please set up groups first before assigning scorekeepers.</p>';
                return;
            }
            
            let html = '';
            
            groups.forEach(group => {
                html += `
                    <div class="match-setup">
                        <h5>${group.name}</h5>
                        <p><strong>Group Members:</strong></p>
                        <ul>
                `;
                
                group.players.forEach(playerId => {
                    const player = getPlayerById(playerId);
                    if (player) {
                        html += `<li>${player.name} (Team ${teams[1].players.find(p => p.id === playerId) ? '1' : '2'})</li>`;
                    }
                });
                
                html += `
                        </ul>
                        <div class="form-group">
                            <label for="scorekeeper_${group.id}">Select Scorekeeper for ${group.name}:</label>
                            <select id="scorekeeper_${group.id}">
                                <option value="">Select a scorekeeper...</option>
                `;
                
                group.players.forEach(playerId => {
                    const player = getPlayerById(playerId);
                    if (player) {
                        const isSelected = group.scorekeeper === playerId ? 'selected' : '';
                        html += `<option value="${playerId}" ${isSelected}>${player.name}</option>`;
                    }
                });
                
                html += `
                            </select>
                        </div>
                    </div>
                `;
            });
            
            assignmentDiv.innerHTML = html;
        }

        function saveScorekeeperAssignment() {
            let assignmentsMade = 0;
            
            groups.forEach(group => {
                const scorekeeperSelect = document.getElementById(`scorekeeper_${group.id}`);
                if (scorekeeperSelect && scorekeeperSelect.value) {
                    group.scorekeeper = scorekeeperSelect.value;
                    assignmentsMade++;
                }
            });
            
            if (assignmentsMade === 0) {
                alert('Please select at least one scorekeeper.');
                return;
            }
            
            saveData();
            alert(`Scorekeeper assignments saved! ${assignmentsMade} of ${groups.length} groups have scorekeepers assigned.`);
        }

        // File import handler
        function handleImportFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = e.target.result;
                    importTournamentData(jsonData);
                } catch (error) {
                    alert('Error reading file. Please ensure it\'s a valid tournament data file.');
                    console.error('File read error:', error);
                }
            };
            reader.readAsText(file);
        }

        // Tournament year functions
        function updateTournamentYear() {
            tournamentYear = parseInt(document.getElementById('tournamentYearInput').value);
            document.getElementById('tournamentYear').textContent = `${tournamentYear} Tournament`;
            saveData();
        }

        // Scorecard functions
        function updateGroupSelect() {
            const select = document.getElementById('groupSelect');
            select.innerHTML = '<option value="">Select a group...</option>';
            
            groups.forEach(group => {
                select.innerHTML += `<option value="${group.id}">${group.name}</option>`;
            });
        }

        function loadScorecard() {
            const groupId = document.getElementById('groupSelect').value;
            if (!groupId) return;

            const group = groups.find(g => g.id === groupId);
            const display = document.getElementById('scorecardDisplay');
            
            if (!group) return;

            // Create scorecard table
            let html = `
                <div class="card">
                    <h3>${group.name} Scorecard - ${courseData.name}</h3>
                    <div class="mobile-responsive">
                        ${createScorecardTable(group)}
                    </div>
                    <button class="btn" onclick="finalizeScorecard('${groupId}')">Finalize Round</button>
                    <button class="btn btn-secondary" onclick="editScorecard('${groupId}')">Edit Scorecard</button>
                </div>
            `;
            
            display.innerHTML = html;
        }

        function createScorecardTable(group) {
            const holes = courseData.holes;
            const frontNine = holes.slice(0, 9);
            const backNine = holes.slice(9, 18);
            
            let html = `
                <table class="scorecard-table">
                    <thead>
                        <tr>
                            <th>Hole</th>
                            ${frontNine.map(h => `<th>${h.number}</th>`).join('')}
                            <th>Out</th>
                            ${backNine.length > 0 ? backNine.map(h => `<th>${h.number}</th>`).join('') + '<th>In</th><th>Total</th>' : ''}
                        </tr>
                        <tr>
                            <th>Par</th>
                            ${frontNine.map(h => `<th>${h.par}</th>`).join('')}
                            <th>${frontNine.reduce((sum, h) => sum + h.par, 0)}</th>
                            ${backNine.length > 0 ? backNine.map(h => `<th>${h.par}</th>`).join('') + `<th>${backNine.reduce((sum, h) => sum + h.par, 0)}</th><th>${holes.reduce((sum, h) => sum + h.par, 0)}</th>` : ''}
                        </tr>
                        <tr>
                            <th>Handicap</th>
                            ${frontNine.map(h => `<th>${h.handicap}</th>`).join('')}
                            <th></th>
                            ${backNine.length > 0 ? backNine.map(h => `<th>${h.handicap}</th>`).join('') + '<th></th><th></th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Add player rows
            group.players.forEach(playerId => {
                const player = getPlayerById(playerId);
                if (player) {
                    html += createPlayerScoringRow(player, group.id, frontNine, backNine);
                }
            });

            html += `
                    </tbody>
                </table>
            `;

            return html;
        }

        function createPlayerScoringRow(player, groupId, frontNine, backNine) {
            let html = `
                <tr>
                    <td><strong>${player.name}</strong><br><small>HCP: ${player.handicap}</small></td>
            `;

            // Front nine gross scores
            frontNine.forEach(hole => {
                const scoreId = `score_${groupId}_${player.id}_${hole.number}`;
                html += `<td><input type="number" id="${scoreId}" class="hole-input" min="1" max="10" onchange="updateNetScore('${groupId}', '${player.id}', ${hole.number}, ${hole.handicap}, ${player.handicap})"></td>`;
            });

            // Front nine total
            html += `<td id="front_${groupId}_${player.id}">-</td>`;

            // Back nine gross scores (if 18 holes)
            if (backNine.length > 0) {
                backNine.forEach(hole => {
                    const scoreId = `score_${groupId}_${player.id}_${hole.number}`;
                    html += `<td><input type="number" id="${scoreId}" class="hole-input" min="1" max="10" onchange="updateNetScore('${groupId}', '${player.id}', ${hole.number}, ${hole.handicap}, ${player.handicap})"></td>`;
                });
                html += `<td id="back_${groupId}_${player.id}">-</td>`;
                html += `<td id="total_${groupId}_${player.id}">-</td>`;
            }

            html += `</tr>`;

            // Net score row
            html += `
                <tr style="background-color: var(--light-gold);">
                    <td><strong>${player.name} (Net)</strong></td>
            `;

            frontNine.forEach(hole => {
                html += `<td id="net_${groupId}_${player.id}_${hole.number}">-</td>`;
            });
            html += `<td id="netfront_${groupId}_${player.id}">-</td>`;

            if (backNine.length > 0) {
                backNine.forEach(hole => {
                    html += `<td id="net_${groupId}_${player.id}_${hole.number}">-</td>`;
                });
                html += `<td id="netback_${groupId}_${player.id}">-</td>`;
                html += `<td id="nettotal_${groupId}_${player.id}">-</td>`;
            }

            html += `</tr>`;

            return html;
        }

        function updateNetScore(groupId, playerId, holeNumber, holeHandicap, playerHandicap) {
            const grossInput = document.getElementById(`score_${groupId}_${playerId}_${holeNumber}`);
            const netCell = document.getElementById(`net_${groupId}_${playerId}_${holeNumber}`);
            
            if (grossInput && netCell) {
                const grossScore = parseInt(grossInput.value) || 0;
                if (grossScore > 0) {
                    const strokes = calculateStrokes(playerHandicap, holeHandicap);
                    const netScore = Math.max(1, grossScore - strokes);
                    netCell.textContent = netScore;
                    
                    // Save the score immediately to storage
                    saveHoleScore(groupId, playerId, holeNumber, grossScore, netScore, holeHandicap);
                    
                    // Update totals
                    updatePlayerTotals(groupId, playerId);
                    
                    // Update live scoring immediately
                    updateLiveScoring();
                    
                    // Save all data to storage
                    saveData();
                }
            }
        }

        function saveHoleScore(groupId, playerId, holeNumber, grossScore, netScore, holeHandicap) {
            // Initialize scorecard structure if it doesn't exist
            if (!scorecards[groupId]) {
                scorecards[groupId] = {};
            }
            
            if (!scorecards[groupId][playerId]) {
                const player = getPlayerById(playerId);
                scorecards[groupId][playerId] = {
                    playerName: player ? player.name : 'Unknown',
                    handicap: player ? player.handicap : 0,
                    scores: {},
                    finalized: false
                };
            }
            
            // Find the par for this hole
            const hole = courseData.holes.find(h => h.number === holeNumber);
            const par = hole ? hole.par : 4;
            
            // Save the hole score
            scorecards[groupId][playerId].scores[holeNumber] = {
                gross: grossScore,
                net: netScore,
                par: par,
                handicap: holeHandicap
            };
            
            console.log(`Saved score for player ${playerId}, hole ${holeNumber}: gross=${grossScore}, net=${netScore}`);
        }

        function loadScorecard() {
            const groupId = document.getElementById('groupSelect').value;
            if (!groupId) return;

            const group = groups.find(g => g.id === groupId);
            const display = document.getElementById('scorecardDisplay');
            
            if (!group) return;

            // Create scorecard table
            let html = `
                <div class="card">
                    <h3>${group.name} Scorecard - ${courseData.name}</h3>
                    <div class="mobile-responsive">
                        ${createScorecardTable(group)}
                    </div>
                    <button class="btn" onclick="finalizeScorecard('${groupId}')">Finalize Round</button>
                    <button class="btn btn-secondary" onclick="editScorecard('${groupId}')">Edit Scorecard</button>
                </div>
            `;
            
            display.innerHTML = html;
            
            // Load existing scores if they exist
            loadExistingScores(groupId);
        }

        function loadExistingScores(groupId) {
            if (!scorecards[groupId]) return;
            
            // Load scores from storage and populate the form
            Object.keys(scorecards[groupId]).forEach(playerId => {
                const playerScores = scorecards[groupId][playerId];
                if (playerScores && playerScores.scores) {
                    Object.keys(playerScores.scores).forEach(holeNumber => {
                        const score = playerScores.scores[holeNumber];
                        
                        // Populate gross score input
                        const grossInput = document.getElementById(`score_${groupId}_${playerId}_${holeNumber}`);
                        if (grossInput) {
                            grossInput.value = score.gross;
                        }
                        
                        // Populate net score display
                        const netCell = document.getElementById(`net_${groupId}_${playerId}_${holeNumber}`);
                        if (netCell) {
                            netCell.textContent = score.net;
                        }
                    });
                    
                    // Update totals
                    updatePlayerTotals(groupId, playerId);
                }
            });
        }

        function createPlayerScoringRow(player, groupId, frontNine, backNine) {
            let html = `
                <tr>
                    <td><strong>${player.name}</strong><br><small>HCP: ${player.handicap}</small></td>
            `;

            // Front nine gross scores
            frontNine.forEach(hole => {
                const scoreId = `score_${groupId}_${player.id}_${hole.number}`;
                html += `<td><input type="number" id="${scoreId}" class="hole-input" min="1" max="10" onchange="updateNetScore('${groupId}', '${player.id}', ${hole.number}, ${hole.handicap}, ${player.handicap})" oninput="updateNetScore('${groupId}', '${player.id}', ${hole.number}, ${hole.handicap}, ${player.handicap})"></td>`;
            });

            // Front nine total
            html += `<td id="front_${groupId}_${player.id}">-</td>`;

            // Back nine gross scores (if 18 holes)
            if (backNine.length > 0) {
                backNine.forEach(hole => {
                    const scoreId = `score_${groupId}_${player.id}_${hole.number}`;
                    html += `<td><input type="number" id="${scoreId}" class="hole-input" min="1" max="10" onchange="updateNetScore('${groupId}', '${player.id}', ${hole.number}, ${hole.handicap}, ${player.handicap})" oninput="updateNetScore('${groupId}', '${player.id}', ${hole.number}, ${hole.handicap}, ${player.handicap})"></td>`;
                });
                html += `<td id="back_${groupId}_${player.id}">-</td>`;
                html += `<td id="total_${groupId}_${player.id}">-</td>`;
            }

            html += `</tr>`;

            // Net score row
            html += `
                <tr style="background-color: var(--light-gold);">
                    <td><strong>${player.name} (Net)</strong></td>
            `;

            frontNine.forEach(hole => {
                html += `<td id="net_${groupId}_${player.id}_${hole.number}">-</td>`;
            });
            html += `<td id="netfront_${groupId}_${player.id}">-</td>`;

            if (backNine.length > 0) {
                backNine.forEach(hole => {
                    html += `<td id="net_${groupId}_${player.id}_${hole.number}">-</td>`;
                });
                html += `<td id="netback_${groupId}_${player.id}">-</td>`;
                html += `<td id="nettotal_${groupId}_${player.id}">-</td>`;
            }

            html += `</tr>`;

            return html;
        }

        function finalizeScorecard(groupId) {
            // Validate that all scores are entered
            const group = groups.find(g => g.id === groupId);
            if (!group) return;
            
            let allScoresEntered = true;
            let missingScores = [];
            
            group.players.forEach(playerId => {
                const player = getPlayerById(playerId);
                if (player) {
                    courseData.holes.forEach(hole => {
                        const grossInput = document.getElementById(`score_${groupId}_${playerId}_${hole.number}`);
                        if (!grossInput || !grossInput.value) {
                            allScoresEntered = false;
                            missingScores.push(`${player.name} - Hole ${hole.number}`);
                        }
                    });
                }
            });
            
            if (!allScoresEntered) {
                const proceedAnyway = confirm(`Some scores are missing:\n${missingScores.slice(0, 5).join('\n')}${missingScores.length > 5 ? '\n...and more' : ''}\n\nDo you want to finalize anyway?`);
                if (!proceedAnyway) return;
            }
            
            // Mark all players in this group as finalized
            if (!scorecards[groupId]) {
                scorecards[groupId] = {};
            }
            
            group.players.forEach(playerId => {
                if (scorecards[groupId][playerId]) {
                    scorecards[groupId][playerId].finalized = true;
                }
            });
            
            saveData();
            updateLiveScoring();
            alert('Scorecard finalized successfully!');
        }

        // Live scoring functions
        function updateLiveScoring() {
            const display = document.getElementById('liveScoreDisplay');
            
            // Check if we have tournament rounds configured
            if (!window.tournamentRounds || window.tournamentRounds.length === 0) {
                display.innerHTML = '<div class="card"><p>No tournament rounds configured yet. Please set up rounds in the Golf Course Setup tab.</p></div>';
                return;
            }
            
            let html = '';
            
            // Display each round with its matches
            window.tournamentRounds.forEach(round => {
                html += `<div class="card"><h3>${round.name} (${round.type.toUpperCase()})</h3>`;
                
                round.matches.forEach(match => {
                    try {
                        html += createLiveMatchDisplay(match, round.scoringType);
                    } catch (error) {
                        console.error('Error creating live match display:', error);
                        html += `<p>Error displaying match data</p>`;
                    }
                });
                
                html += '</div>';
            });
            
            display.innerHTML = html || '<div class="card"><p>No matches configured yet. Please set up matches in the Golf Course Setup tab.</p></div>';
        }

        function createLiveMatchDisplay(match, roundScoringType) {
            try {
                if (match.type === '2v2') {
                    return create2v2LiveDisplay(match, roundScoringType);
                } else if (match.type === '1v1') {
                    return create1v1LiveDisplay(match);
                } else if (match.type === '4v4') {
                    return create4v4LiveDisplay(match);
                }
            } catch (error) {
                console.error('Error in createLiveMatchDisplay:', error);
                return '<p>Error displaying this match</p>';
            }
            return '';
        }

        function create2v2LiveDisplay(match, scoringType) {
            // Get actual player objects
            const team1Players = match.team1.map(id => getPlayerById(id)).filter(p => p);
            const team2Players = match.team2.map(id => getPlayerById(id)).filter(p => p);
            
            if (team1Players.length !== 2 || team2Players.length !== 2) {
                return `<p>Error: Incomplete team data for 2v2 match</p>`;
            }
            
            const actualScoringType = scoringType || match.scoringType || 'best';
            
            let html = `
                <div class="live-score-match">
                    <h4>2v2 Match ${match.matchNumber}: ${team1Players.map(p => p.name).join(' & ')} vs ${team2Players.map(p => p.name).join(' & ')}</h4>
                    <p><strong>Scoring:</strong> ${actualScoringType === 'best' ? 'Best Net Score' : 'Combined Net Score'}</p>
                    <div class="mobile-responsive">
                        <table class="scorecard-table">
                            <thead>
                                <tr>
                                    <th>Team</th>
                                    ${courseData.holes.slice(0, 9).map(h => `<th>${h.number}</th>`).join('')}
                                    <th>Bonus</th>
                                    <th>Total</th>
                                    ${courseData.holes.length > 9 ? courseData.holes.slice(9).map(h => `<th>${h.number}</th>`).join('') + '<th>Bonus</th><th>Total</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Team 1 display
            html += createTeamLiveRow(match.team1, 1, match, actualScoringType);
            // Team 2 display  
            html += createTeamLiveRow(match.team2, 2, match, actualScoringType);
            // Points row
            html += createPointsRow(match);
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            return html;
        }

        function create1v1LiveDisplay(match) {
            const team1Player = getPlayerById(match.team1[0]);
            const team2Player = getPlayerById(match.team2[0]);
            
            if (!team1Player || !team2Player) {
                return `<p>Error: Player data not found for 1v1 match</p>`;
            }
            
            let html = `
                <div class="live-score-match">
                    <h4>1v1 Match ${match.matchNumber}: ${team1Player.name} vs ${team2Player.name}</h4>
                    <div class="mobile-responsive">
                        <table class="scorecard-table">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    ${courseData.holes.slice(0, 9).map(h => `<th>${h.number}</th>`).join('')}
                                    <th>Bonus</th>
                                    <th>Total</th>
                                    ${courseData.holes.length > 9 ? courseData.holes.slice(9).map(h => `<th>${h.number}</th>`).join('') + '<th>Bonus</th><th>Total</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            html += createPlayerLiveRow(match.team1[0], match, 1);
            html += createPlayerLiveRow(match.team2[0], match, 2);
            html += createPointsRow(match);
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            return html;
        }

        function createTeamLiveRow(playerIds, teamNum, match, scoringType) {
            const teamName = teamNum === 1 ? (teams[1].name || 'Team 1') : (teams[2].name || 'Team 2');
            const players = playerIds.map(id => getPlayerById(id)).filter(p => p);
            
            if (players.length === 0) {
                return `<tr><td colspan="20">Error: No players found for team ${teamNum}</td></tr>`;
            }
            
            let html = `
                <tr>
                    <td><strong>${teamName}</strong><br>
            `;
            
            players.forEach(player => {
                html += `${player.name} (${player.handicap})<br>`;
            });
            
            html += `</td>`;
            
            // Add hole scores based on match scoring type
            courseData.holes.slice(0, 9).forEach(hole => {
                const teamScore = calculateTeamScore(playerIds, hole.number, scoringType);
                html += `<td>${teamScore !== null ? teamScore : '-'}</td>`;
            });
            
            // Calculate front nine points
            const frontPoints = calculateNinePoints(match, 1, 9);
            html += `<td>${frontPoints.bonus[`team${teamNum}`]}</td>`;
            html += `<td>${frontPoints.total[`team${teamNum}`]}</td>`;
            
            // Back nine if 18 holes
            if (courseData.holes.length > 9) {
                courseData.holes.slice(9).forEach(hole => {
                    const teamScore = calculateTeamScore(playerIds, hole.number, scoringType);
                    html += `<td>${teamScore !== null ? teamScore : '-'}</td>`;
                });
                
                const backPoints = calculateNinePoints(match, 10, 18);
                html += `<td>${backPoints.bonus[`team${teamNum}`]}</td>`;
                html += `<td>${backPoints.total[`team${teamNum}`]}</td>`;
            }
            
            html += `</tr>`;
            return html;
        }

        function createPlayerLiveRow(playerId, match, teamNum) {
            const player = getPlayerById(playerId);
            if (!player) {
                return `<tr><td colspan="20">Error: Player not found</td></tr>`;
            }
            
            let html = `
                <tr>
                    <td><strong>${player.name}</strong><br>(HCP: ${player.handicap})</td>
            `;
            
            // Front nine scores
            courseData.holes.slice(0, 9).forEach(hole => {
                const netScore = getPlayerNetScore(playerId, hole.number);
                html += `<td>${netScore !== null ? netScore : '-'}</td>`;
            });
            
            // Calculate front nine points for this player's matches
            const frontPoints = calculateNinePoints(match, 1, 9);
            html += `<td>${frontPoints.bonus[`team${teamNum}`]}</td>`;
            html += `<td>${frontPoints.total[`team${teamNum}`]}</td>`;
            
            // Back nine if 18 holes
            if (courseData.holes.length > 9) {
                courseData.holes.slice(9).forEach(hole => {
                    const netScore = getPlayerNetScore(playerId, hole.number);
                    html += `<td>${netScore !== null ? netScore : '-'}</td>`;
                });
                
                const backPoints = calculateNinePoints(match, 10, 18);
                html += `<td>${frontPoints.bonus[`team${teamNum}`]}</td>`;
                html += `<td>${frontPoints.total[`team${teamNum}`]}</td>`;
            }
            
            html += `</tr>`;
            return html;
        }

        function create4v4LiveDisplay(match) {
            return `
                <div class="live-score-match">
                    <h4>4v4 Alternate Shot Match</h4>
                    <p>Team 1 Handicap: ${match.team1Handicap || 'Not set'}</p>
                    <p>Team 2 Handicap: ${match.team2Handicap || 'Not set'}</p>
                    <div class="mobile-responsive">
                        <table class="scorecard-table">
                            <thead>
                                <tr>
                                    <th>Team</th>
                                    ${courseData.holes.slice(0, 9).map(h => `<th>${h.number}</th>`).join('')}
                                    <th>Bonus</th>
                                    <th>Total</th>
                                    ${courseData.holes.length > 9 ? courseData.holes.slice(9).map(h => `<th>${h.number}</th>`).join('') + '<th>Bonus</th><th>Total</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Team 1</strong></td>
                                    ${courseData.holes.slice(0, 9).map(h => `<td>-</td>`).join('')}
                                    <td>-</td>
                                    <td>-</td>
                                    ${courseData.holes.length > 9 ? courseData.holes.slice(9).map(h => `<td>-</td>`).join('') + '<td>-</td><td>-</td>' : ''}
                                </tr>
                                <tr>
                                    <td><strong>Team 2</strong></td>
                                    ${courseData.holes.slice(0, 9).map(h => `<td>-</td>`).join('')}
                                    <td>-</td>
                                    <td>-</td>
                                    ${courseData.holes.length > 9 ? courseData.holes.slice(9).map(h => `<td>-</td>`).join('') + '<td>-</td><td>-</td>' : ''}
                                </tr>
                                <tr style="background-color: var(--light-gold);">
                                    <td><strong>Points</strong></td>
                                    ${courseData.holes.slice(0, 9).map(h => `<td>-</td>`).join('')}
                                    <td>-</td>
                                    <td>-</td>
                                    ${courseData.holes.length > 9 ? courseData.holes.slice(9).map(h => `<td>-</td>`).join('') + '<td>-</td><td>-</td>' : ''}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function createTeamLiveRow(players, teamNum, match) {
            let html = `
                <tr>
                    <td><strong>Team ${teamNum}</strong><br>
            `;
            
            players.forEach(player => {
                html += `${player.name} (${player.handicap})<br>`;
            });
            
            html += `</td>`;
            
            // Add hole scores based on match scoring type
            courseData.holes.forEach(hole => {
                const teamScore = calculateTeamScore(players, hole.number, match.scoringType);
                html += `<td>${teamScore}</td>`;
            });
            
            // Add bonus and total columns
            html += `<td>-</td><td>-</td>`;
            
            if (courseData.holes.length > 9) {
                html += `<td>-</td><td>-</td>`;
            }
            
            html += `</tr>`;
            return html;
        }

        function createPlayerLiveRow(player, match) {
            let html = `
                <tr>
                    <td><strong>${player.name}</strong><br>(HCP: ${player.handicap})</td>
            `;
            
            courseData.holes.forEach(hole => {
                const netScore = getPlayerNetScore(player.id, hole.number);
                html += `<td>${netScore || '-'}</td>`;
            });
            
            html += `<td>-</td><td>-</td>`;
            
            if (courseData.holes.length > 9) {
                html += `<td>-</td><td>-</td>`;
            }
            
            html += `</tr>`;
            return html;
        }

        function createPointsRow(match) {
            let html = `
                <tr style="background-color: var(--light-gold);">
                    <td><strong>Points</strong></td>
            `;
            
            courseData.holes.forEach(hole => {
                const points = calculateHolePoints(match, hole.number);
                html += `<td>${points.team1} - ${points.team2}</td>`;
            });
            
            // Calculate front nine points and bonus
            const frontPoints = calculateNinePoints(match, 1, 9);
            html += `<td>${frontPoints.bonus}</td><td>${frontPoints.total}</td>`;
            
            if (courseData.holes.length > 9) {
                const backPoints = calculateNinePoints(match, 10, 18);
                html += `<td>${backPoints.bonus}</td><td>${backPoints.total}</td>`;
            }
            
            html += `</tr>`;
            return html;
        }

        function getPlayerNetScore(playerId, holeNumber) {
            // Search through all scorecards to find this player's net score
            for (const groupId in scorecards) {
                if (scorecards[groupId][playerId] && scorecards[groupId][playerId].scores && scorecards[groupId][playerId].scores[holeNumber]) {
                    return scorecards[groupId][playerId].scores[holeNumber].net;
                }
            }
            return null;
        }

        function calculateTeamScore(players, holeNumber, scoringType) {
            const scores = [];
            
            players.forEach(player => {
                const playerId = typeof player === 'string' ? player : player.id;
                const netScore = getPlayerNetScore(playerId, holeNumber);
                if (netScore !== null) {
                    scores.push(netScore);
                }
            });
            
            if (scores.length === 0) return null;
            
            if (scoringType === 'best') {
                return Math.min(...scores);
            } else if (scoringType === 'combined') {
                return scores.reduce((sum, score) => sum + score, 0);
            }
            
            return null;
        }

        function calculateHolePoints(match, holeNumber) {
            if (match.type === '2v2') {
                const team1Score = calculateTeamScore(match.team1, holeNumber, match.scoringType || 'best');
                const team2Score = calculateTeamScore(match.team2, holeNumber, match.scoringType || 'best');
                
                if (team1Score === null || team2Score === null) {
                    return {team1: 0, team2: 0};
                }
                
                if (team1Score < team2Score) {
                    return {team1: 2, team2: 0};
                } else if (team2Score < team1Score) {
                    return {team1: 0, team2: 2};
                } else {
                    return {team1: 1, team2: 1};
                }
            } else if (match.type === '1v1') {
                const team1Score = getPlayerNetScore(match.team1[0], holeNumber);
                const team2Score = getPlayerNetScore(match.team2[0], holeNumber);
                
                if (team1Score === null || team2Score === null) {
                    return {team1: 0, team2: 0};
                }
                
                if (team1Score < team2Score) {
                    return {team1: 2, team2: 0};
                } else if (team2Score < team1Score) {
                    return {team1: 0, team2: 2};
                } else {
                    return {team1: 1, team2: 1};
                }
            } else if (match.type === '4v4') {
                // For 4v4 alternate shot, would need team scores entered separately
                // This is a placeholder - actual implementation would depend on how team scores are entered
                return {team1: 0, team2: 0};
            }
            
            return {team1: 0, team2: 0};
        }

        function calculateNinePoints(match, startHole, endHole) {
            let team1Points = 0;
            let team2Points = 0;
            
            for (let hole = startHole; hole <= endHole && hole <= courseData.holes.length; hole++) {
                const points = calculateHolePoints(match, hole);
                team1Points += points.team1;
                team2Points += points.team2;
            }
            
            // Add bonus points
            let bonus = {team1: 0, team2: 0};
            if (team1Points > team2Points) {
                bonus.team1 = 2;
            } else if (team2Points > team1Points) {
                bonus.team2 = 2;
            } else {
                bonus.team1 = 1;
                bonus.team2 = 1;
            }
            
            return {
                team1: team1Points,
                team2: team2Points,
                bonus: bonus,
                total: {
                    team1: team1Points + bonus.team1,
                    team2: team2Points + bonus.team2
                }
            };
        }

        function createTeamLiveRow(players, teamNum, match) {
            const teamName = teamNum === 1 ? (teams[1].name || 'Team 1') : (teams[2].name || 'Team 2');
            
            let html = `
                <tr>
                    <td><strong>${teamName}</strong><br>
            `;
            
            players.forEach(player => {
                const playerObj = getPlayerById(player);
                if (playerObj) {
                    html += `${playerObj.name} (${playerObj.handicap})<br>`;
                }
            });
            
            html += `</td>`;
            
            // Add hole scores based on match scoring type
            courseData.holes.slice(0, 9).forEach(hole => {
                const teamScore = calculateTeamScore(players, hole.number, match.scoringType || 'best');
                html += `<td>${teamScore !== null ? teamScore : '-'}</td>`;
            });
            
            // Calculate front nine points
            const frontPoints = calculateNinePoints(match, 1, 9);
            html += `<td>${frontPoints.bonus[`team${teamNum}`]}</td>`;
            html += `<td>${frontPoints.total[`team${teamNum}`]}</td>`;
            
            // Back nine if 18 holes
            if (courseData.holes.length > 9) {
                courseData.holes.slice(9).forEach(hole => {
                    const teamScore = calculateTeamScore(players, hole.number, match.scoringType || 'best');
                    html += `<td>${teamScore !== null ? teamScore : '-'}</td>`;
                });
                
                const backPoints = calculateNinePoints(match, 10, 18);
                html += `<td>${backPoints.bonus[`team${teamNum}`]}</td>`;
                html += `<td>${backPoints.total[`team${teamNum}`]}</td>`;
            }
            
            html += `</tr>`;
            return html;
        }

        function createPlayerLiveRow(player, match) {
            const playerObj = getPlayerById(player);
            if (!playerObj) return '';
            
            let html = `
                <tr>
                    <td><strong>${playerObj.name}</strong><br>(HCP: ${playerObj.handicap})</td>
            `;
            
            // Front nine scores
            courseData.holes.slice(0, 9).forEach(hole => {
                const netScore = getPlayerNetScore(player, hole.number);
                html += `<td>${netScore !== null ? netScore : '-'}</td>`;
            });
            
            // Calculate front nine points for this player's matches
            const frontPoints = calculateNinePoints(match, 1, 9);
            const teamNum = match.team1.includes(player) ? 1 : 2;
            html += `<td>${frontPoints.bonus[`team${teamNum}`]}</td>`;
            html += `<td>${frontPoints.total[`team${teamNum}`]}</td>`;
            
            // Back nine if 18 holes
            if (courseData.holes.length > 9) {
                courseData.holes.slice(9).forEach(hole => {
                    const netScore = getPlayerNetScore(player, hole.number);
                    html += `<td>${netScore !== null ? netScore : '-'}</td>`;
                });
                
                const backPoints = calculateNinePoints(match, 10, 18);
                html += `<td>${backPoints.bonus[`team${teamNum}`]}</td>`;
                html += `<td>${backPoints.total[`team${teamNum}`]}</td>`;
            }
            
            html += `</tr>`;
            return html;
        }

        function createPointsRow(match) {
            let html = `
                <tr style="background-color: var(--light-gold); font-weight: bold;">
                    <td><strong>Points Won</strong></td>
            `;
            
            // Front nine hole-by-hole points
            courseData.holes.slice(0, 9).forEach(hole => {
                const points = calculateHolePoints(match, hole.number);
                html += `<td>${points.team1} - ${points.team2}</td>`;
            });
            
            // Front nine totals
            const frontPoints = calculateNinePoints(match, 1, 9);
            html += `<td>${frontPoints.bonus.team1} - ${frontPoints.bonus.team2}</td>`;
            html += `<td><strong>${frontPoints.total.team1} - ${frontPoints.total.team2}</strong></td>`;
            
            // Back nine if 18 holes
            if (courseData.holes.length > 9) {
                courseData.holes.slice(9).forEach(hole => {
                    const points = calculateHolePoints(match, hole.number);
                    html += `<td>${points.team1} - ${points.team2}</td>`;
                });
                
                const backPoints = calculateNinePoints(match, 10, 18);
                html += `<td>${backPoints.bonus.team1} - ${backPoints.bonus.team2}</td>`;
                html += `<td><strong>${backPoints.total.team1} - ${backPoints.total.team2}</strong></td>`;
            }
            
            html += `</tr>`;
            return html;
        }

        // Overall scoring functions
        function updateOverallScoring() {
            updateTeamTotals();
            updateRoundResults();
            updateMVPLeaderboard();
        }

        function updateTeamTotals() {
            document.getElementById('team1NameDisplay').textContent = teams[1].name || 'Team 1';
            document.getElementById('team2NameDisplay').textContent = teams[2].name || 'Team 2';
            
            // Calculate total points from all matches
            let team1Total = 0;
            let team2Total = 0;
            
            matches.forEach(match => {
                const matchPoints = calculateMatchTotalPoints(match);
                team1Total += matchPoints.team1;
                team2Total += matchPoints.team2;
            });
            
            document.getElementById('team1TotalPoints').textContent = team1Total;
            document.getElementById('team2TotalPoints').textContent = team2Total;
        }

        function calculateMatchTotalPoints(match) {
            let team1Total = 0;
            let team2Total = 0;
            
            // Front nine
            const frontPoints = calculateNinePoints(match, 1, 9);
            const frontTeam1 = parseInt(frontPoints.total.split(' - ')[0]) || 0;
            const frontTeam2 = parseInt(frontPoints.total.split(' - ')[1]) || 0;
            team1Total += frontTeam1;
            team2Total += frontTeam2;
            
            // Back nine if 18 holes
            if (courseData.holes.length > 9) {
                const backPoints = calculateNinePoints(match, 10, 18);
                const backTeam1 = parseInt(backPoints.total.split(' - ')[0]) || 0;
                const backTeam2 = parseInt(backPoints.total.split(' - ')[1]) || 0;
                team1Total += backTeam1;
                team2Total += backTeam2;
            }
            
            return {team1: team1Total, team2: team2Total};
        }

        function updateRoundResults() {
            const display = document.getElementById('roundResults');
            let html = '';
            
            matches.forEach((match, index) => {
                const points = calculateMatchTotalPoints(match);
                const matchName = getMatchDisplayName(match, index);
                
                html += `
                    <div class="team-display">
                        <div>
                            <strong>${matchName}</strong>
                        </div>
                        <div class="points-display">
                            ${points.team1} - ${points.team2}
                        </div>
                        <div>
                            ${points.team1 > points.team2 ? 'Team 1 Wins' : points.team2 > points.team1 ? 'Team 2 Wins' : 'Tie'}
                        </div>
                    </div>
                `;
            });
            
            display.innerHTML = html;
        }

        function getMatchDisplayName(match, index) {
            if (match.type === '2v2') {
                const team1Players = match.team1.map(id => getPlayerById(id)).filter(p => p);
                const team2Players = match.team2.map(id => getPlayerById(id)).filter(p => p);
                return `2v2: ${team1Players.map(p => p.name).join(' & ')} vs ${team2Players.map(p => p.name).join(' & ')}`;
            } else if (match.type === '1v1') {
                const team1Player = getPlayerById(match.team1[0]);
                const team2Player = getPlayerById(match.team2[0]);
                return `1v1: ${team1Player?.name || 'Unknown'} vs ${team2Player?.name || 'Unknown'}`;
            } else if (match.type === '4v4') {
                return '4v4 Alternate Shot';
            }
            return `Match ${index + 1}`;
        }

        function updateMVPLeaderboard() {
            const mvpSelect = document.getElementById('mvpSelect');
            const leaderboard = document.getElementById('mvpLeaderboard');
            
            if (!mvpSelect || !leaderboard) return;
            
            // Calculate player performance for MVP consideration
            const playerStats = {};
            
            // Collect all players
            [...teams[1].players, ...teams[2].players].forEach(player => {
                playerStats[player.id] = {
                    name: player.name,
                    handicap: player.handicap,
                    totalNet: 0,
                    roundCount: 0,
                    wins: 0,
                    losses: 0,
                    ties: 0
                };
            });
            
            // Calculate stats from scorecards
            Object.values(scorecards).forEach(groupScores => {
                Object.keys(groupScores).forEach(playerId => {
                    if (playerStats[playerId] && groupScores[playerId].scores) {
                        const playerScores = Object.values(groupScores[playerId].scores);
                        const totalNet = playerScores.reduce((sum, score) => sum + score.net, 0);
                        playerStats[playerId].totalNet += totalNet;
                        playerStats[playerId].roundCount++;
                    }
                });
            });
            
            // Sort by average net score
            const sortedPlayers = Object.values(playerStats)
                .filter(p => p.roundCount > 0)
                .sort((a, b) => (a.totalNet / a.roundCount) - (b.totalNet / b.roundCount))
                .slice(0, 3);
            
            // Update MVP select dropdown
            mvpSelect.innerHTML = '<option value="">Select MVP...</option>';
            Object.values(playerStats).forEach(player => {
                mvpSelect.innerHTML += `<option value="${player.name}">${player.name}</option>`;
            });
            
            // Update leaderboard display
            let leaderboardHtml = '<h4>Top 3 MVP Candidates</h4>';
            sortedPlayers.forEach((player, index) => {
                const avgNet = (player.totalNet / player.roundCount).toFixed(1);
                leaderboardHtml += `
                    <div class="team-display">
                        <div><strong>#${index + 1} ${player.name}</strong></div>
                        <div>Avg Net: ${avgNet}</div>
                        <div>Rounds: ${player.roundCount}</div>
                    </div>
                `;
            });
            
            leaderboard.innerHTML = leaderboardHtml;
        }

        function selectMVP() {
            const mvp = document.getElementById('mvpSelect').value;
            if (mvp) {
                tournamentData.mvp = mvp;
                saveData();
                alert(`${mvp} selected as MVP!`);
            }
        }

        function exportOverallScoring() {
            const data = {
                teams: teams,
                matches: matches,
                scores: scorecards,
                totalPoints: {
                    team1: document.getElementById('team1TotalPoints').textContent,
                    team2: document.getElementById('team2TotalPoints').textContent
                },
                mvp: tournamentData.mvp,
                year: tournamentYear
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `brother-frank-cup-${tournamentYear}-overall-scoring.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Player statistics functions
        function updatePlayerStatistics() {
            const display = document.getElementById('playerStatsDisplay');
            let html = '';
            
            [...teams[1].players, ...teams[2].players].forEach(player => {
                html += createPlayerStatsCard(player);
            });
            
            display.innerHTML = html;
        }

        function createPlayerStatsCard(player) {
            const stats = calculatePlayerStatistics(player.id);
            
            let html = `
                <div class="card">
                    <h3>${player.name} (Handicap: ${player.handicap})</h3>
                    
                    <h4>Round Scores</h4>
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>Round</th>
                                <th>Front 9 (Gross)</th>
                                <th>Back 9 (Gross)</th>
                                <th>Total (Gross)</th>
                                <th>Front 9 (Net)</th>
                                <th>Back 9 (Net)</th>
                                <th>Total (Net)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            stats.rounds.forEach((round, index) => {
                html += `
                    <tr>
                        <td>Round ${index + 1}</td>
                        <td>${round.frontGross}</td>
                        <td>${round.backGross}</td>
                        <td>${round.totalGross}</td>
                        <td>${round.frontNet}</td>
                        <td>${round.backNet}</td>
                        <td>${round.totalNet}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                    
                    <h4>Scoring Summary</h4>
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Eagles</th>
                                <th>Birdies</th>
                                <th>Pars</th>
                                <th>Bogeys</th>
                                <th>Double+</th>
                                <th>Other</th>
                                <th>Hole in One</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Gross</strong></td>
                                <td>${stats.gross.eagles}</td>
                                <td>${stats.gross.birdies}</td>
                                <td>${stats.gross.pars}</td>
                                <td>${stats.gross.bogeys}</td>
                                <td>${stats.gross.doubles}</td>
                                <td>${stats.gross.other}</td>
                                <td>${stats.gross.holeInOne}</td>
                            </tr>
                            <tr>
                                <td><strong>Net</strong></td>
                                <td>${stats.net.eagles}</td>
                                <td>${stats.net.birdies}</td>
                                <td>${stats.net.pars}</td>
                                <td>${stats.net.bogeys}</td>
                                <td>${stats.net.doubles}</td>
                                <td>${stats.net.other}</td>
                                <td>${stats.net.holeInOne}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <h4>Match Record</h4>
                    <p><strong>Wins:</strong> ${stats.record.wins} | <strong>Losses:</strong> ${stats.record.losses} | <strong>Ties:</strong> ${stats.record.ties}</p>
                </div>
            `;
            
            return html;
        }

        function calculatePlayerStatistics(playerId) {
            const stats = {
                rounds: [],
                gross: {eagles: 0, birdies: 0, pars: 0, bogeys: 0, doubles: 0, other: 0, holeInOne: 0},
                net: {eagles: 0, birdies: 0, pars: 0, bogeys: 0, doubles: 0, other: 0, holeInOne: 0},
                record: {wins: 0, losses: 0, ties: 0}
            };
            
            // Calculate from scorecards
            Object.values(scorecards).forEach(groupScores => {
                if (groupScores[playerId] && groupScores[playerId].scores) {
                    const roundStats = {
                        frontGross: 0, backGross: 0, totalGross: 0,
                        frontNet: 0, backNet: 0, totalNet: 0
                    };
                    
                    Object.values(groupScores[playerId].scores).forEach(holeScore => {
                        const hole = holeScore;
                        
                        // Add to round totals
                        if (hole.par <= 9) {
                            roundStats.frontGross += hole.gross;
                            roundStats.frontNet += hole.net;
                        } else {
                            roundStats.backGross += hole.gross;
                            roundStats.backNet += hole.net;
                        }
                        roundStats.totalGross += hole.gross;
                        roundStats.totalNet += hole.net;
                        
                        // Calculate scoring statistics
                        const grossDiff = hole.gross - hole.par;
                        const netDiff = hole.net - hole.par;
                        
                        // Gross stats
                        if (hole.gross === 1) stats.gross.holeInOne++;
                        else if (grossDiff <= -2) stats.gross.eagles++;
                        else if (grossDiff === -1) stats.gross.birdies++;
                        else if (grossDiff === 0) stats.gross.pars++;
                        else if (grossDiff === 1) stats.gross.bogeys++;
                        else if (grossDiff === 2) stats.gross.doubles++;
                        else stats.gross.other++;
                        
                        // Net stats
                        if (hole.net === 1) stats.net.holeInOne++;
                        else if (netDiff <= -2) stats.net.eagles++;
                        else if (netDiff === -1) stats.net.birdies++;
                        else if (netDiff === 0) stats.net.pars++;
                        else if (netDiff === 1) stats.net.bogeys++;
                        else if (netDiff === 2) stats.net.doubles++;
                        else stats.net.other++;
                    });
                    
                    stats.rounds.push(roundStats);
                }
            });
            
            return stats;
        }

        function exportPlayerStats() {
            const playerStats = {};
            
            [...teams[1].players, ...teams[2].players].forEach(player => {
                playerStats[player.name] = calculatePlayerStatistics(player.id);
            });
            
            const data = {
                year: tournamentYear,
                players: playerStats,
                course: courseData.name,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `brother-frank-cup-${tournamentYear}-player-stats.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Tournament history functions
        function updateTournamentHistory() {
            const display = document.getElementById('tournamentHistoryDisplay');
            const history = JSON.parse(localStorage.getItem('brotherFrankCupHistory') || '[]');
            
            let html = '';
            
            if (history.length === 0) {
                html = '<p>No tournament history available. Finalize a tournament to create history records.</p>';
            } else {
                history.forEach(tournament => {
                    html += createTournamentHistoryCard(tournament);
                });
            }
            
            display.innerHTML = html;
        }

        function createTournamentHistoryCard(tournament) {
            return `
                <div class="tournament-history-link" onclick="expandTournamentHistory('${tournament.year}')">
                    <h4>${tournament.year} Brother Frank Cup</h4>
                    <p><strong>Winner:</strong> ${tournament.winner} (${tournament.finalScore})</p>
                    <p><strong>Course:</strong> ${tournament.course}</p>
                    <p><strong>MVP:</strong> ${tournament.mvp || 'Not selected'}</p>
                    <p><strong>Total Matches:</strong> ${tournament.totalMatches}</p>
                </div>
                <div id="history_${tournament.year}" style="display: none;">
                    ${createDetailedTournamentHistory(tournament)}
                </div>
            `;
        }

        function createDetailedTournamentHistory(tournament) {
            let html = `
                <div class="card">
                    <h4>Detailed Results for ${tournament.year}</h4>
                    
                    <h5>Final Team Scores</h5>
                    <div class="team-display">
                        <div><strong>${tournament.teams.team1.name}</strong></div>
                        <div class="points-display">${tournament.teams.team1.points}</div>
                        <div><strong>${tournament.teams.team2.name}</strong></div>
                        <div class="points-display">${tournament.teams.team2.points}</div>
                    </div>
                    
                    <h5>Player Statistics</h5>
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th>Team</th>
                                <th>Record (W-L-T)</th>
                                <th>Avg Gross</th>
                                <th>Avg Net</th>
                                <th>Birdies+</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            tournament.playerStats.forEach(player => {
                html += `
                    <tr>
                        <td><strong>${player.name}</strong></td>
                        <td>${player.team}</td>
                        <td>${player.wins}-${player.losses}-${player.ties}</td>
                        <td>${player.avgGross}</td>
                        <td>${player.avgNet}</td>
                        <td>${player.birdiesPlus}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return html;
        }

        function expandTournamentHistory(year) {
            const element = document.getElementById(`history_${year}`);
            if (element) {
                element.style.display = element.style.display === 'none' ? 'block' : 'none';
            }
        }

        function finalizeTournament() {
            if (!confirm('Are you sure you want to finalize this tournament? This action cannot be undone.')) {
                return;
            }
            
            const history = JSON.parse(localStorage.getItem('brotherFrankCupHistory') || '[]');
            
            // Calculate final tournament data
            const team1Points = parseInt(document.getElementById('team1TotalPoints').textContent) || 0;
            const team2Points = parseInt(document.getElementById('team2TotalPoints').textContent) || 0;
            
            const tournamentRecord = {
                year: tournamentYear,
                course: courseData.name,
                teams: {
                    team1: {name: teams[1].name, points: team1Points},
                    team2: {name: teams[2].name, points: team2Points}
                },
                winner: team1Points > team2Points ? teams[1].name : team2Points > team1Points ? teams[2].name : 'Tie',
                finalScore: `${team1Points} - ${team2Points}`,
                mvp: tournamentData.mvp,
                totalMatches: matches.length,
                playerStats: calculateFinalPlayerStats(),
                matches: matches,
                scorecards: scorecards,
                finalizedDate: new Date().toISOString()
            };
            
            history.push(tournamentRecord);
            localStorage.setItem('brotherFrankCupHistory', JSON.stringify(history));
            
            alert(`Tournament ${tournamentYear} has been finalized and saved to history!`);
            updateTournamentHistory();
        }

        function calculateFinalPlayerStats() {
            const finalStats = [];
            
            [...teams[1].players, ...teams[2].players].forEach(player => {
                const stats = calculatePlayerStatistics(player.id);
                const teamName = teams[1].players.find(p => p.id === player.id) ? teams[1].name : teams[2].name;
                
                const avgGross = stats.rounds.length > 0 ? 
                    (stats.rounds.reduce((sum, r) => sum + r.totalGross, 0) / stats.rounds.length).toFixed(1) : 0;
                const avgNet = stats.rounds.length > 0 ? 
                    (stats.rounds.reduce((sum, r) => sum + r.totalNet, 0) / stats.rounds.length).toFixed(1) : 0;
                
                finalStats.push({
                    name: player.name,
                    team: teamName,
                    wins: stats.record.wins,
                    losses: stats.record.losses,
                    ties: stats.record.ties,
                    avgGross: avgGross,
                    avgNet: avgNet,
                    birdiesPlus: stats.gross.eagles + stats.gross.birdies + stats.net.eagles + stats.net.birdies
                });
            });
            
            return finalStats;
        }

        // Utility functions
        function getPlayerById(playerId) {
            for (const team of Object.values(teams)) {
                const player = team.players.find(p => p.id === playerId);
                if (player) return player;
            }
            return null;
        }

        function updateDisplays() {
            if (currentUser === 'admin') {
                updateHoleSetup();
                updateScorekeeperAssignment();
                displaySavedRounds();
                updateOverallScoring();
                updatePlayerStatistics();
                updateTournamentHistory();
            }
            
            if (currentUser === 'scorer' || currentUser === 'admin') {
                updateLiveScoring();
            }
        }

        // Initialize the application when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
    </script>
</body>
</html>
